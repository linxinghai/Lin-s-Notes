# RTOS

[https://www.cnblogs.com/yangguang-it/p/7233591.html](https://www.cnblogs.com/yangguang-it/p/7233591.html)

多线程调度器

栈
队列

Thumb‐2

LDR

加载内存中的数据到寄存器中

STR

将寄存器中的数据写入到内存中

ADD,SUB
push 

PUSH {LR,R13}

pop 

POP

寄存器

R13
sp栈
入栈时按寄存器标号顺序入栈
R14
lr返回地址
R15
pc当前指令地址

汇编

PUSH{R0,R1,LR}//压栈    PUSHA

LDR R0,[addrA]//读

ADD R0,R1,R2//计算

STR [addrA],R0//写

POP{R0,R1,PC}//弹栈    POPAD

任务

触发中断
保存现场
压栈全部寄存器
中断执行完毕
弹栈全部寄存器
恢复现场

任务 = 函数 + 任务现场(栈)
(运行中的函数)

创建任务
*函数指针
任务名称 (*p)()
*栈深 malloc分配
参数
*优先级
句柄(结构体指针)
TCB
栈顶
两链表
优先级
栈
任务名

创建任务栈

调度机制

高优先级抢占低优先级,
高优先级运行中不执行低优先,
同级优先轮流执行(时间片轮转)

状态
运行
就绪
阻塞 等待某个条件
暂停 单纯被禁用

管理
寻找高优先级
加入链表排队

就绪链表(每个优先级对应一个链表)

延迟链表

空闲任务(用于清理被杀死的任务)

TICK中断
切换任务中断(1ms)

空闲任务主动礼让一个tick
若有优先级为0的任务时

freertos

config.h配置

- INCLUDE_
    
    允许声明api函数
    

任务创建与删除

- 动态xTaskCreate()
    
    任务函数
    任务名字
    任务栈大小
    传递给任务函数的参数
    任务优先级
    任务句柄
    
- 静态
    
    xTaskCreateStatic()
    
    创建成功时返回句柄
    
    任务函数
    任务名字
    任务堆栈大小
    传递给任务函数的参数
    任务优先级
    任务堆栈
    任务控制块
    
- 保护
    
    与正常的创建没有区别
    但是要求mcu具有mpu内存保护单元
    
    是任务呗mpu所保护
    
    任务参数结构体
    句柄
    

删除

vTaskDelete() 删除的参数是函数的句柄 

句柄:句柄:是指cpu在运行当前多个线程是会给每个进程分配一个唯一的id

删除本质是回收分配的句柄从而结束该进程

任务挂起和恢复

一般放在一个循环的选择语句

挂起vTaskSuspend()

恢复

vTaskResume()

vTaskResumeFromISR()

cortex-m中断管理

中断

中断向量控制器(NVIC)

中断请求IRQ
不可屏蔽中断NMI
Systick滴答定时器
系统异常

中断管理

NVIC_type
SCB_type

列表
任务状态或信息查询
任务运行时间统计
内核控制
临界段代码保护
时间管理
队列
信号量
二值信号量
优先级
互斥信号
软件定时器
事件标志组
任务通知
低功耗
空闲任务
内存管理
任务调度器
任务切换
队列上锁
入队函数
出队函数

句柄:是指cpu在运行当前多个线程是会给每个进程分配一个唯一的id

删除本质是回收分配的句柄从而结束该进程

句柄:是指cpu在运行当前多个线程是会给每个进程分配一个唯一的id

删除本质是回收分配的句柄从而结束该进程

vTaskDelete()

删除的参数是函数的句柄

句柄:是指cpu在运行当前多个线程是会给每个进程分配一个唯一的id

删除本质是回收分配的句柄从而结束该进程

任务挂起和恢复
挂起
恢复
cortex-m中断管理
中断
中断向量控制器(NVIC)
中断请求IRQ
不可屏蔽中断NMI
Systick滴答定时器
系统异常
中断管理
NVIC_type
SCB_type
列表
任务状态或信息查询
任务运行时间统计
内核控制
临界段代码保护
时间管理
队列
信号量
二值信号量
优先级
互斥信号
软件定时器
事件标志组
任务通知
低功耗
空闲任务
内存管理
任务调度器
任务切换
队列上锁
入队函数
出队函数

任务挂起和恢复
挂起
恢复
cortex-m中断管理
中断
中断向量控制器(NVIC)
中断请求IRQ
不可屏蔽中断NMI
Systick滴答定时器
系统异常
中断管理
NVIC_type
SCB_type
列表
任务状态或信息查询
任务运行时间统计
内核控制
临界段代码保护
时间管理
队列
信号量
二值信号量
优先级
互斥信号
软件定时器
事件标志组
任务通知
低功耗
空闲任务
内存管理
任务调度器
任务切换
队列上锁
入队函数
出队函数

vTaskDelete()

删除的参数是函数的句柄

句柄:是指cpu在运行当前多个线程是会给每个进程分配一个唯一的id

删除本质是回收分配的句柄从而结束该进程

freertos内核管理

任务管理

任务控制块

时间管理

时钟节拍产生

任务延时管理

内存管理

- heap_1/2/3/4
    
    分配简单,时间确定
    只分配,不回收
    
    动态分配,最佳匹配
    碎片,时间不定
    
    调用标准库函数
    速度慢,时间不定
    
    相邻空闲内存可合并
    碎片,合并效率低
    

通信管理

消息管理

消息队列

任务同步

信号量

互斥量

临界区

taskENTER_CRITICAL()

taskEXIT_CRITICAL()

任务调度

vTaskStartScheduler()

luatos